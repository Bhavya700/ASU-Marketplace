---
// src/pages/listings/[id].astro
import Layout from '../../layouts/Layout.astro';
import { supabase } from '../../supabase/client';

// Get the listing ID from the URL
const { id } = Astro.params;

if (!id) {
    return Astro.redirect('/explore');
}

// Fetch the single listing by its ID
const { data: listing, error } = await supabase
  .from('listings')
  .select(`
    *,
    listing_categories ( categories ( name ) )
  `)
  .eq('id', id)
  .single(); // .single() is crucial to get one object, not an array

if (error || !listing) {
  console.error('Error fetching listing:', error);
  return Astro.redirect('/404');
}

const category = listing.listing_categories[0]?.categories?.name || 'General';
const date = new Date(listing.created_at).toLocaleDateString('en-US', {
    month: 'long', day: 'numeric', year: 'numeric'
});
---
<Layout title={listing.title}>
    <div class="container mx-auto max-w-4xl px-6 py-8">
        <div class="bg-white rounded-lg shadow-lg overflow-hidden md:flex">
            <div class="md:w-1/2">
                <img src={listing.image_url} alt={listing.title} class="w-full h-64 md:h-full object-cover">
            </div>
            <div class="p-8 md:w-1/2 flex flex-col">
                <p class="text-sm text-gray-500 mb-2">Posted on {date}</p>
                <h1 class="text-4xl font-bold text-asu-dark-grey mb-2">{listing.title}</h1>
                <span class="bg-asu-maroon text-white font-semibold py-1 px-3 rounded-full self-start mb-4">{category}</span>
                
                <p class="text-gray-700 mb-6 flex-grow">{listing.description}</p>

                <div class="flex justify-between items-center border-t pt-4">
                    <div>
                        <p class="text-lg text-gray-600">Quantity: {listing.quantity}</p>
                        <p class="text-3xl font-bold text-asu-maroon">${listing.price}</p>
                    </div>
                    <button class="bg-asu-gold text-asu-dark-grey font-bold py-3 px-6 rounded-lg hover:opacity-90 transition-opacity">
                        Message Seller
                    </button>
                </div>
            </div>
        </div>
    </div>
</Layout>