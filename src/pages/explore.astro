---
// src/pages/explore.astro
import Layout from '../layouts/Layout.astro';
import { supabase } from '../supabase/client';
import ListingCard from '../components/astro/ListingCard.astro';
import CategoryFilters from '../components/astro/CategoryFilters.astro';

// SERVER-SIDE DATA FETCHING! This runs before the page is sent to the browser.
const { data: listings, error } = await supabase
  .from('listings')
  .select(`
    id,
    title,
    price,
    quantity,
    image_url,
    created_at,
    listing_categories (
        categories ( name )
    )
  `)
  .eq('status', 'available') // Only show available listings
  .order('created_at', { ascending: false }); // Show newest first

if (error) {
    console.error('Error fetching listings:', error);
}
---

<Layout title="Explore Listings">
    <div class="container mx-auto px-4 md:px-6 py-8">
        <CategoryFilters />

        <div class="my-6 flex flex-col md:flex-row gap-4 justify-center items-center">
            {/* Search and Map UI remains the same */}
        </div>

        <!-- Listings Grid -->
        {listings && listings.length > 0 ? (
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                {listings.map(listing => (
                    <ListingCard listing={listing} />
                ))}
            </div>
        ) : (
            <div class="text-center py-16">
                <p class="text-gray-600">No listings found. Be the first to create one!</p>
            </div>
        )}
    </div>
</Layout>